{% extends "base.html" %}
{% block title %}Flujo A: Ajuste de medida{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>FLUJO A: Filtros para Ajuste de medida</h2>
  
  <!-- Formulario que envía la selección final al servidor (POST /flujoA) -->
  <form id="flujoAForm" method="POST" action="/flujoA">
    
    <!-- Radio Buttons SI/NO -->
    <div class="mb-3">
      <label class="form-label">¿Ajuste de medida?</label><br>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="ajusteMedida" id="ajusteMedidaSI" value="SI">
        <label class="form-check-label" for="ajusteMedidaSI">SI</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="ajusteMedida" id="ajusteMedidaNO" value="NO">
        <label class="form-check-label" for="ajusteMedidaNO">NO</label>
      </div>
    </div>

    <!-- Sección que sólo se muestra si el usuario elige "SI" -->
    <div id="diametroSection" class="mb-3" style="display:none;">
      <label for="diametros" class="form-label">Seleccione DIÁMETRO(s)</label>
      <select class="form-select" id="diametros" name="diametros" multiple>
        <!-- Estas opciones se llenarán dinámicamente con JavaScript usando diamData -->
      </select>
      <small class="text-muted">Use Ctrl/Cmd para seleccionar múltiples opciones.</small>
    </div>

    <!-- Contenedor para las opciones (TIPO, GRADO_ACERO, etc.) -->
    <div id="optionsContainer"></div>

    <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Obtenemos el objeto diamData desde la variable de plantilla
  // diamData viene como un string JSON, lo parseamos a objeto JS
  const diamData = JSON.parse('{{ diamData | safe }}');

  // Radio Buttons: mostrar u ocultar la sección de diámetros
  const radioSI = document.getElementById('ajusteMedidaSI');
  const radioNO = document.getElementById('ajusteMedidaNO');
  const diamSection = document.getElementById('diametroSection');
  const optionsContainer = document.getElementById('optionsContainer');
  const diamSelect = document.getElementById('diametros');

  radioSI.addEventListener('change', () => {
    if (radioSI.checked) {
      diamSection.style.display = 'block';
    }
  });
  radioNO.addEventListener('change', () => {
    if (radioNO.checked) {
      diamSection.style.display = 'none';
      optionsContainer.innerHTML = '';
    }
  });

  // 1) Llenamos el <select> de DIÁMETROS con las keys de diamData
  //    (p.e. "0.875", "1.0", etc.)
  for (const diam in diamData) {
    let option = document.createElement('option');
    option.value = diam; // "0.875"
    option.textContent = diam;
    diamSelect.appendChild(option);
  }

  // 2) Cada vez que el usuario cambia la selección de DIÁMETROS,
  //    generamos dinámicamente los pick-lists para TIPO, GRADO_ACERO,
  //    GRADO_ACERO_CUPLA, TIPO_DE_CUPLA, etc.
  diamSelect.addEventListener('change', function() {
    // Obtenemos la lista de DIÁMETROS seleccionados
    const selected = Array.from(this.selectedOptions).map(o => o.value);
    // Limpiamos el contenedor para no duplicar
    optionsContainer.innerHTML = '';

    selected.forEach(d => {
      // Creamos un div "card" para cada DIÁMETRO
      const sectionDiv = document.createElement('div');
      sectionDiv.classList.add('border', 'p-3', 'mb-3');
      sectionDiv.innerHTML = `<h5 class="mb-3">Opciones para DIÁMETRO: ${d}</h5>`;

      // TIPO
      const labelTipo = document.createElement('label');
      labelTipo.classList.add('form-label');
      labelTipo.textContent = 'TIPO (seleccione):';
      sectionDiv.appendChild(labelTipo);

      const selectTipo = document.createElement('select');
      // Importante: name="tipo_diam[]" para que en el POST se identifique
      selectTipo.name = `tipo_${d}[]`;
      selectTipo.classList.add('form-select', 'mb-3');
      selectTipo.multiple = true; // Permite selección múltiple
      (diamData[d].TIPO || []).forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        selectTipo.appendChild(opt);
      });
      sectionDiv.appendChild(selectTipo);

      // GRADO_ACERO
      const labelAcero = document.createElement('label');
      labelAcero.classList.add('form-label');
      labelAcero.textContent = 'GRADO DE ACERO (seleccione):';
      sectionDiv.appendChild(labelAcero);

      const selectAcero = document.createElement('select');
      selectAcero.name = `acero_${d}[]`;
      selectAcero.classList.add('form-select', 'mb-3');
      selectAcero.multiple = true;
      (diamData[d].GRADO_ACERO || []).forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        selectAcero.appendChild(opt);
      });
      sectionDiv.appendChild(selectAcero);

      // GRADO_ACERO_CUPLA
      const labelAceroCupla = document.createElement('label');
      labelAceroCupla.classList.add('form-label');
      labelAceroCupla.textContent = 'GRADO DE ACERO CUPLA (seleccione):';
      sectionDiv.appendChild(labelAceroCupla);

      const selectAceroCupla = document.createElement('select');
      selectAceroCupla.name = `acero_cupla_${d}[]`;
      selectAceroCupla.classList.add('form-select', 'mb-3');
      selectAceroCupla.multiple = true;
      (diamData[d].GRADO_ACERO_CUPLA || []).forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        selectAceroCupla.appendChild(opt);
      });
      sectionDiv.appendChild(selectAceroCupla);

      // TIPO_DE_CUPLA
      const labelTipoCupla = document.createElement('label');
      labelTipoCupla.classList.add('form-label');
      labelTipoCupla.textContent = 'TIPO DE CUPLA (seleccione):';
      sectionDiv.appendChild(labelTipoCupla);

      const selectTipoCupla = document.createElement('select');
      selectTipoCupla.name = `tipo_cupla_${d}[]`;
      selectTipoCupla.classList.add('form-select', 'mb-3');
      selectTipoCupla.multiple = true;
      (diamData[d].TIPO_DE_CUPLA || []).forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        selectTipoCupla.appendChild(opt);
      });
      sectionDiv.appendChild(selectTipoCupla);

      // Agregamos todo al contenedor
      optionsContainer.appendChild(sectionDiv);
    });
  });
</script>
{% endblock %}

