{% extends "base.html" %}
{% block title %}Flujo A: Ajuste de medida{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>FLUJO A: Filtros para Ajuste de medida</h2>
  
  <!-- Formulario que envía la selección final al servidor -->
  <form id="flujoAForm" method="POST" action="/flujoA" enctype="multipart/form-data">
    
    <!-- Opción SI o NO -->
    <div class="mb-3">
      <label class="form-label">¿Ajuste de medida?</label><br>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="ajusteMedida" id="ajusteMedidaSI" value="SI">
        <label class="form-check-label" for="ajusteMedidaSI">SI</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="ajusteMedida" id="ajusteMedidaNO" value="NO">
        <label class="form-check-label" for="ajusteMedidaNO">NO</label>
      </div>
    </div>

    <!-- Sección para la selección de DIÁMETROS (oculta si NO se elige "SI") -->
    <div id="diametroSection" class="mb-3" style="display:none;">
      <label for="diametros" class="form-label">Seleccione DIÁMETRO(s)</label>
      <select class="form-select" id="diametros" name="diametros" multiple>
        <!-- Estas opciones se llenan dinámicamente con JavaScript (o desde el backend) -->
      </select>
      <small class="text-muted">Use Ctrl/Cmd para seleccionar múltiples opciones.</small>
    </div>

    <!-- Contenedor donde se generarán los pick lists de TIPO, GRADO DE ACERO, ACERO CUPLA, TIPO CUPLA -->
    <div id="optionsContainer"></div>

    <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// ----------------------------------------------------------------------
// Ejemplo de datos en un objeto JavaScript.
// En un caso real, podrías generar este objeto desde tu backend, con
// los datos leídos del Excel y convertirlos a JSON para usarlos aquí.
//
// Cada key (p.e. "0.875") representa un DIÁMETRO. El value es otro objeto
// que contiene arrays con las opciones de TIPO, ACERO, ACERO_CUPLA, TIPO_CUPLA.
// ----------------------------------------------------------------------
const diamData = {
  "0.875": {
    "TIPO":         ["TipoA", "TipoB", "TipoC"],
    "ACERO":        ["Acero1", "Acero2"],
    "ACERO_CUPLA":  ["Cupla1", "Cupla2"],
    "TIPO_CUPLA":   ["TC1", "TC2"]
  },
  "1.0": {
    "TIPO":         ["TipoX", "TipoY"],
    "ACERO":        ["Acero3", "Acero4"],
    "ACERO_CUPLA":  ["CuplaX", "CuplaY"],
    "TIPO_CUPLA":   ["TCX", "TCY"]
  }
  // Agrega aquí todos los diámetros que manejes en tu Excel
};

// ----------------------------------------------------------------------
// Lógica para mostrar/ocultar la sección de DIÁMETROS según SI/NO
// ----------------------------------------------------------------------
document.getElementById('ajusteMedidaSI').addEventListener('change', function() {
  if (this.checked) {
    document.getElementById('diametroSection').style.display = 'block';
  }
});
document.getElementById('ajusteMedidaNO').addEventListener('change', function() {
  if (this.checked) {
    document.getElementById('diametroSection').style.display = 'none';
    // Limpiamos la sección de picklists
    document.getElementById('optionsContainer').innerHTML = '';
  }
});

// ----------------------------------------------------------------------
// Llenamos el <select> de DIÁMETROS con los keys de diamData
// ----------------------------------------------------------------------
const diametrosSelect = document.getElementById('diametros');
for (const diam in diamData) {
  let option = document.createElement('option');
  option.value = diam;
  option.text = diam;
  diametrosSelect.appendChild(option);
}

// ----------------------------------------------------------------------
// Cada vez que el usuario cambia la selección de DIÁMETROS, generamos
// dinámicamente los pick lists de TIPO, ACERO, ACERO CUPLA y TIPO CUPLA
// para cada DIÁMETRO seleccionado.
// ----------------------------------------------------------------------
diametrosSelect.addEventListener('change', function() {
  const selectedDiam = Array.from(this.selectedOptions).map(o => o.value);
  const container = document.getElementById('optionsContainer');
  container.innerHTML = ''; // Limpiamos contenido anterior

  selectedDiam.forEach(d => {
    // Creamos un contenedor (div) para cada DIÁMETRO seleccionado
    const sectionDiv = document.createElement('div');
    sectionDiv.classList.add('border', 'p-3', 'mb-3');
    sectionDiv.innerHTML = `<h5 class="mb-3">Opciones para DIÁMETRO: ${d}</h5>`;

    // --------------------- TIPO ---------------------
    const tipoLabel = document.createElement('label');
    tipoLabel.classList.add('form-label');
    tipoLabel.textContent = 'TIPO (seleccione):';
    sectionDiv.appendChild(tipoLabel);

    const tipoSelect = document.createElement('select');
    tipoSelect.name = `tipo_${d}[]`;  // p.e. tipo_0.875[]
    tipoSelect.classList.add('form-select', 'mb-3');
    tipoSelect.multiple = true;       // Permite seleccionar varios TIPO
    diamData[d]["TIPO"].forEach(item => {
      let opt = document.createElement('option');
      opt.value = item;
      opt.text = item;
      tipoSelect.appendChild(opt);
    });
    sectionDiv.appendChild(tipoSelect);

    // --------------------- GRADO DE ACERO ---------------------
    const aceroLabel = document.createElement('label');
    aceroLabel.classList.add('form-label');
    aceroLabel.textContent = 'GRADO DE ACERO (seleccione):';
    sectionDiv.appendChild(aceroLabel);

    const aceroSelect = document.createElement('select');
    aceroSelect.name = `acero_${d}[]`;  // p.e. acero_0.875[]
    aceroSelect.classList.add('form-select', 'mb-3');
    aceroSelect.multiple = true;
    diamData[d]["ACERO"].forEach(item => {
      let opt = document.createElement('option');
      opt.value = item;
      opt.text = item;
      aceroSelect.appendChild(opt);
    });
    sectionDiv.appendChild(aceroSelect);

    // --------------------- ACERO CUPLA ---------------------
    const aceroCupLabel = document.createElement('label');
    aceroCupLabel.classList.add('form-label');
    aceroCupLabel.textContent = 'ACERO CUPLA (seleccione):';
    sectionDiv.appendChild(aceroCupLabel);

    const aceroCupSelect = document.createElement('select');
    aceroCupSelect.name = `acero_cupla_${d}[]`;
    aceroCupSelect.classList.add('form-select', 'mb-3');
    aceroCupSelect.multiple = true;
    diamData[d]["ACERO_CUPLA"].forEach(item => {
      let opt = document.createElement('option');
      opt.value = item;
      opt.text = item;
      aceroCupSelect.appendChild(opt);
    });
    sectionDiv.appendChild(aceroCupSelect);

    // --------------------- TIPO CUPLA ---------------------
    const tipoCupLabel = document.createElement('label');
    tipoCupLabel.classList.add('form-label');
    tipoCupLabel.textContent = 'TIPO CUPLA (seleccione):';
    sectionDiv.appendChild(tipoCupLabel);

    const tipoCupSelect = document.createElement('select');
    tipoCupSelect.name = `tipo_cupla_${d}[]`;
    tipoCupSelect.classList.add('form-select', 'mb-3');
    tipoCupSelect.multiple = true;
    diamData[d]["TIPO_CUPLA"].forEach(item => {
      let opt = document.createElement('option');
      opt.value = item;
      opt.text = item;
      tipoCupSelect.appendChild(opt);
    });
    sectionDiv.appendChild(tipoCupSelect);

    // Agregamos todo al contenedor principal
    container.appendChild(sectionDiv);
  });
});
</script>
{% endblock %}

